<!doctype html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Marky</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        /* MODERN UI VARIABLES - Blue Palette */
        :root{
            --page-bg: #eef2f7;
            --glass-bg: rgba(255,255,255,0.45);
            --glass-border: rgba(255,255,255,0.25);
            --text-dark: #1f2937;
            --text-muted: #6b7280;
            --radius: 16px;
            --blur: 14px;
            --shadow: 0 6px 25px rgba(0,0,0,0.08);
            --primary-color: #2563eb; /* Deep Blue Primary */
            --primary-light: #3b82f6; /* Lighter Blue */
        }

        /* Page & Beautiful Background */
        body{
            margin:0;
            padding:30px;
            background:
                radial-gradient(circle at 20% 20%, rgba(255,255,255,0.6), rgba(238,242,247,0.4) 40%),
                radial-gradient(circle at 80% 80%, rgba(255,255,255,0.4), rgba(238,242,247,0.2) 60%),
                var(--page-bg);
            font-family: Inter, system-ui, sans-serif;
            color: var(--text-dark);
            -webkit-font-smoothing: antialiased;
        }

        .container{
            max-width:1100px;
            margin:auto;
            display:flex;
            flex-direction:column;
            gap:25px;
        }

        /* Glass card */
        .glass{
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding:20px;
            backdrop-filter: blur(var(--blur));
            -webkit-backdrop-filter: blur(var(--blur));
            box-shadow: var(--shadow);
        }

        /* Header - BIGGER HEADING */
        h1{ margin:0 0 6px 0; font-size:36px; font-weight: 700; color: var(--primary-color); text-align: center; }
        p.lead{ margin:0; color:var(--text-muted); font-size:16px; text-align: center; }

        /* Form / Textarea */
        textarea{
            width:100%;
            /* ðŸ”‘ Same Size: Set explicit height for Markdown box (200px) */
            height:200px; 
            padding:12px;
            font-size:14px;
            border-radius:12px;
            border:1px solid var(--glass-border);
            font-family: ui-monospace, Consolas, monospace;
            box-sizing:border-box;
            resize:vertical;
            background: rgba(255,255,255,0.7);
            transition: border-color 0.2s;
        }
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }

        .controls{
            margin-top:10px;
            display:flex;
            gap:10px;
        }

        /* BLUE LIQUID GLASS BUTTONS */
        button{
            padding:10px 18px;
            border-radius:12px;
            cursor:pointer;
            font-size:14px;
            transition: transform 0.15s, box-shadow 0.15s, background 0.15s;
            border: 1px solid var(--primary-light);
            background: rgba(59, 130, 246, 0.15); /* Light blue glass background */
            color: var(--primary-color); /* Dark blue text */
            font-weight: 600;
        }

        button:hover{
            background: rgba(59, 130, 246, 0.3); /* Slightly darker blue hover */
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }

        /* Primary Button (Render) */
        button[type="submit"]{
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
        }

        button[type="submit"]:hover{
            background: var(--primary-light);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.6);
            transform: translateY(-2px);
        }
        
        /* Preview box */
        .preview{
            background: rgba(255,255,255,0.65);
            border:1px solid rgba(255,255,255,0.4);
            border-radius:14px;
            padding:16px;
            /* ðŸ”‘ Same Size: Min-height matches the textarea height (200px) */
            min-height:200px;
            white-space:pre-wrap;
            overflow:auto;
            box-shadow: inset 0 0 25px rgba(255,255,255,0.2);
        }
        h3{
            color: var(--primary-color);
            border-bottom: 2px solid rgba(37, 99, 235, 0.2);
            padding-bottom: 8px;
            margin-bottom: 12px;
        }

        .download-row{
            margin-top:12px;
            display:flex;
            gap:10px;
            align-items:center;
        }

        .spinner {
            display: inline-block;
            width:18px;
            height:18px;
            border:3px solid rgba(0,0,0,0.12);
            border-top-color: var(--primary-color);
            border-radius:50%;
            animation: spin 0.9s linear infinite;
            margin-left:6px;
            vertical-align:middle;
        }
        .hidden { display:none; }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media(max-width:900px){
            .two-col{ grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">

        <div>
            <h1>Marky Editor</h1>
            <p class="lead">Markdown to HTML converter.</p>
        </div>

        <div class="glass">
            <form method="post" action="/render">
                <textarea id="md-area" name="md" placeholder="# Write your Markdown here">{{ md | default('') }}</textarea>

                <div class="controls">
                    <button type="submit">Render</button>
                    <button type="button" onclick="clearText()">Clear</button>
                </div>
            </form>
        </div>
        
        <!-- plain content (for debugging / optional) -->
        <template id="plain-content">{{ plain | default('') | tojson }}</template>

        <div class="glass">
            <h3 style="margin-top:0">HTML Preview</h3>
            <div id="preview-box" class="preview">
    {% if corrected_text %}
        {# corrected_text is plain text from API; convert double-newlines to paragraphs #}
        {% for para in corrected_text.split('\n\n') %}
            <p>{{ para | e }}</p>
        {% endfor %}
    {% elif corrected_html %}
        {{ corrected_html | safe }}
    {% elif html %}
        {{ html | safe }}
    {% else %}
        <!-- empty -->
    {% endif %}
</div>
            
            <div class="download-row">
                <button onclick="downloadPreviewText()">Download Text</button>
                <button id="correct-btn" onclick="correctPreviewText()">Correct the Text</button>
                <div id="spinner" class="spinner hidden" title="Processing..."></div>
            </div>
        </div>

    </div>

    <script>
        function clearText(){
            document.getElementById("md-area").value = "";
            document.getElementById("preview-box").innerHTML = "";
        }

        function downloadPreviewText(){
            const text = document.getElementById("preview-box").innerText.trim();
            if(!text){ alert("Nothing to download."); return; }

            const blob = new Blob([text], {type:"text/plain"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "html_preview.txt";
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        async function correctPreviewText() {
            const preview = document.getElementById("preview-box");
            const html = preview.innerHTML.trim();
            if (!html) { alert("Nothing to correct."); return; }

            // show spinner and disable button
            const spinner = document.getElementById("spinner");
            const btn = document.getElementById("correct-btn");
            spinner.classList.remove("hidden");
            btn.disabled = true;
            btn.style.opacity = 0.7;

            try {
                const response = await fetch("/correct", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ html: html })
                });

                if (!response.ok) {
                    let msg = "Correction failed.";
                    try {
                        const err = await response.json();
                        msg = err.detail || JSON.stringify(err);
                    } catch(_) {}
                    alert(msg);
                    return;
                }

                const data = await response.json();

                // Server should return { corrected_html: "<p>...</p>" }
                if (data.corrected_html) {
                    preview.innerHTML = data.corrected_html;
                } else if (data.corrected_text) {
                    // fallback: convert corrected_text (plain) to safe paragraphs while preserving existing links
                    // We'll try a basic approach: preserve existing anchor tags, replace other text nodes.
                    // Simpler fallback: just set textContent (links would be lost) â€” so prefer corrected_html on server.
                    preview.textContent = data.corrected_text;
                } else {
                    alert("No corrected content returned.");
                }
            } catch (err) {
                console.error(err);
                alert("Network or server error while correcting text.");
            } finally {
                spinner.classList.add("hidden");
                btn.disabled = false;
                btn.style.opacity = 1;
            }
        }
    </script>

</body>
</html>
